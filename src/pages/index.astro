---
import Layout from '../layouts/Layout.astro';
import { Image } from 'astro:assets';
import PlaylistViewer from '../components/PlaylistViewer.astro';
import { getPlaylistInfo } from '../lib/spotify';

const PLAYLIST_ID = import.meta.env.PLAYLIST_ID || '0UNaot0tAdf4Oqa8L1hK88';

const CACHE_TIME = 60 * 60;

let playlistInfo;

try {
  const cached = Astro.request.headers.get('x-playlist-cache');
  if (cached) {
    console.log('Using cached playlist', cached);
    playlistInfo = JSON.parse(cached);
  } else {
    playlistInfo = await getPlaylistInfo(PLAYLIST_ID);

    Astro.response.headers.set('Cache-Control', `max-age=${CACHE_TIME}`);
    Astro.response.headers.set('x-playlist-cache', JSON.stringify(playlistInfo));
  }
} catch (e: any) {
  console.error('Error fetching playlist:', e);
}

if (playlistInfo) {
  const { playlist } = await import('@/stores/playlist');
  playlist.set(playlistInfo);
}
---

<!-- ---
import Layout from '../layouts/Layout.astro'
import { Image } from 'astro:assets'
import { getPlaylistInfo } from '../lib/spotify'
import PlaylistViewer from '../components/PlaylistViewer.astro'

// const DEFAULT_PLAYLIST_ID = '0UNaot0tAdf4Oqa8L1hK88'
// import playlistInfo from '../playlistInfo.json'
let playlistInfo
playlistInfo = await getPlaylistInfo('0UNaot0tAdf4Oqa8L1hK88')
import { playlist } from '@/stores/playlist'
playlist.set(playlistInfo)
--- -->
<Layout title='Trackerfy'>
	<header
		class='relative z-10 mx-auto flex max-w-md items-center justify-center bg-[#1C1B1B] pt-7'
	>
		<Image
			src='/spotify-logo.png'
			alt='Spotify Logo'
			width={100}
			height={30}
			loading={'eager'}
		/>
	</header>
	<PlaylistViewer playlistInfo={playlistInfo} />
</Layout>
